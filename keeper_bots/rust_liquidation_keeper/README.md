# Rust Liquidation Keeper

ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„æ æ†ä»£å¸ç³»ç»Ÿæ¸…ç®—æœºå™¨äººã€‚

## ğŸš€ æ¶æ„æ¦‚è¿°

è¿™ä¸ªé¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œæ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹å¼€å‘ï¼š

```
src/
â”œâ”€â”€ main.rs          # åº”ç”¨å…¥å£å’Œä»»åŠ¡åè°ƒ
â”œâ”€â”€ config.rs        # é…ç½®ç®¡ç†
â”œâ”€â”€ database.rs      # æ•°æ®å­˜å‚¨æŠ½è±¡å±‚
â”œâ”€â”€ events.rs        # åŒºå—é“¾äº‹ä»¶ç›‘æ§
â”œâ”€â”€ liquidation.rs   # æ¸…ç®—é€»è¾‘
â””â”€â”€ nav.rs          # NAV è®¡ç®—å’Œç›‘æ§
```

## ğŸ“¦ å½“å‰çŠ¶æ€

âœ… **å·²å®Œæˆçš„åŸºç¡€æ¡†æ¶**
- é¡¹ç›®ç»“æ„å’Œä¾èµ–ç®¡ç†
- åŸºæœ¬çš„å¼‚æ­¥è¿è¡Œæ—¶è®¾ç½®
- é…ç½®ç³»ç»Ÿ (TOML æ ¼å¼)
- ç»“æ„åŒ–æ—¥å¿— (tracing)
- æ¨¡å—åŒ–çš„è®¾è®¡æ¨¡å¼
- æ•°æ®åº“æŠ½è±¡å±‚å‡†å¤‡
- Web3 é›†æˆå‡†å¤‡

â³ **å¾…å®ç°çš„åŠŸèƒ½æ¨¡å—**

### 1. æ•°æ®åº“æ¨¡å— (`src/database.rs`)
- RocksDB é›†æˆ
- ç”¨æˆ·æŒä»“å­˜å‚¨
- NAV å€¼ç¼“å­˜
- æ‹å–çŠ¶æ€æŒä¹…åŒ–

### 2. äº‹ä»¶ç›‘æ§ (`src/events.rs`)
- Web3 äº‹ä»¶è¿‡æ»¤å™¨
- åˆçº¦äº‹ä»¶ç›‘å¬
- å®æ—¶æ•°æ®æ›´æ–°

### 3. NAV è®¡ç®— (`src/nav.rs`)
- æ æ†ä»£å¸ NAV å…¬å¼
- åˆ©æ¯æ‰£é™¤è®¡ç®—
- ä»·æ ¼æ•°æ®è·å–

### 4. æ¸…ç®—é€»è¾‘ (`src/liquidation.rs`)
- é£é™©è¯„ä¼°ç®—æ³•
- æ¸…ç®—é˜ˆå€¼ç›‘æ§
- è‡ªåŠ¨åŒ–æ¸…ç®—æµç¨‹

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **Rust 2021 Edition**
- **Web3.rs** - ä»¥å¤ªåŠåŒºå—é“¾äº¤äº’
- **Tokio** - å¼‚æ­¥è¿è¡Œæ—¶
- **RocksDB** - æŒä¹…åŒ–å­˜å‚¨
- **Anyhow** - é”™è¯¯å¤„ç†
- **Tracing** - ç»“æ„åŒ–æ—¥å¿—
- **Config** - é…ç½®ç®¡ç†

## ğŸš€ å¼€å‘æŒ‡å—

### 1. è¿è¡Œé¡¹ç›®

```bash
# æ£€æŸ¥ä»£ç 
cargo check

# è¿è¡Œï¼ˆç›®å‰ä¼šæŒ‚èµ·ï¼Œå› ä¸ºåŠŸèƒ½å°šæœªå®ç°ï¼‰
cargo run

# æ„å»ºå‘å¸ƒç‰ˆæœ¬
cargo build --release
```

### 2. é…ç½®

ç¼–è¾‘ `config.toml` æ–‡ä»¶æ¥è®¾ç½®ï¼š
- RPC èŠ‚ç‚¹ URL
- åˆçº¦åœ°å€
- æ¸…ç®—é˜ˆå€¼
- ç›‘æ§é—´éš”

### 3. å¼€å‘æ­¥éª¤å»ºè®®

**ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“é›†æˆ**
```rust
// åœ¨ src/database.rs ä¸­æ·»åŠ  RocksDB å®ç°
pub struct Database {
    db: rocksdb::DB,
}
```

**ç¬¬äºŒæ­¥ï¼šäº‹ä»¶ç›‘å¬**
```rust
// åœ¨ src/events.rs ä¸­å®ç°äº‹ä»¶è¿‡æ»¤å™¨
// ç›‘å¬ Mintã€Burnã€Transfer äº‹ä»¶
```

**ç¬¬ä¸‰æ­¥ï¼šNAV è®¡ç®—**
```rust
// å®ç°æ æ†ä»£å¸ NAV å…¬å¼
fn calculate_nav(leverage: LeverageType, price: U256) -> U256 {
    // ä¿å®ˆå‹: (9*Pt - P0) / (8*P0)
    // ä¸­æ€§å‹: (5*Pt - P0) / (4*P0)
    // æ¿€è¿›å‹: (2*Pt - P0) / (1*P0)
}
```

**ç¬¬å››æ­¥ï¼šæ¸…ç®—ç›‘æ§**
```rust
// å®ç° ex-interest NAV è®¡ç®—
// æ£€æŸ¥æ˜¯å¦ä½äºæ¸…ç®—é˜ˆå€¼
```

## ğŸ“Š æ•°æ®æ¨¡å‹

### ç”¨æˆ·æŒä»“
```rust
struct UserPosition {
    user: Address,
    token_id: u64,
    amount: U256,
    mint_price: U256,
    interest_accrued: U256,
    last_update: u64,
}
```

### NAV æ•°æ®
```rust
struct TokenNav {
    token_id: u64,
    nav_value: U256,
    last_update: u64,
}
```

## ğŸ”§ é…ç½®ç¤ºä¾‹

```toml
[default]
rpc_url = "http://localhost:8545"
liquidation_threshold = 8000        # 80% (åŸºç¡€ç‚¹)
adjustment_threshold = 8500         # 85% (åŸºç¡€ç‚¹)
nav_recalc_interval = 300           # 5åˆ†é’Ÿ
liquidation_check_interval = 30     # 30ç§’
current_interest_rate = 300         # 3% (åŸºç¡€ç‚¹)

[default.contracts]
custodian = "0x..."
liquidation_manager = "0x..."
auction_manager = "0x..."
interest_manager = "0x..."
token = "0x..."
oracle = "0x..."
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_nav_calculation

# å¸¦è¾“å‡ºè¿è¡Œ
cargo test -- --nocapture
```

## ğŸ“ é¡¹ç›®ç»“æ„è¯¦è§£

### `src/main.rs`
- åº”ç”¨åˆå§‹åŒ–
- å¹¶å‘ä»»åŠ¡ç®¡ç†
- ä¼˜é›…å…³æœºå¤„ç†

### `src/config.rs`
- é…ç½®åŠ è½½å’ŒéªŒè¯
- ç¯å¢ƒå˜é‡æ”¯æŒ
- é»˜è®¤å€¼è®¾ç½®

### `src/database.rs`
- æ•°æ®æŒä¹…åŒ–æ¥å£
- æŸ¥è¯¢ä¼˜åŒ–
- äº‹åŠ¡ç®¡ç†

## ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

1. **æ•°æ®åº“å±‚å®ç°** - é›†æˆ RocksDBï¼Œå®šä¹‰æ•°æ®æ¨¡å¼
2. **æ™ºèƒ½åˆçº¦é›†æˆ** - æ·»åŠ åˆçº¦ ABI å’Œè°ƒç”¨æ¥å£
3. **äº‹ä»¶ç›‘å¬å™¨** - å®ç°å®æ—¶åŒºå—é“¾äº‹ä»¶ç›‘æ§
4. **NAV è®¡ç®—å¼•æ“** - å®ç°ç²¾ç¡®çš„ä»·æ ¼å’Œåˆ©æ¯è®¡ç®—
5. **æ¸…ç®—å¼•æ“** - æ¸…ç®—å†³ç­–å’Œæ‰§è¡Œé€»è¾‘
6. **ç›‘æ§å’Œå‘Šè­¦** - ç³»ç»Ÿå¥åº·æ£€æŸ¥å’Œé”™è¯¯æŠ¥å‘Š
7. **API æ¥å£** - REST API ç”¨äºçŠ¶æ€æŸ¥è¯¢å’Œç®¡ç†
8. **æµ‹è¯•è¦†ç›–** - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestã€‚è¯·ç¡®ä¿ï¼š
- ä»£ç ç¬¦åˆ Rust æœ€ä½³å®è·µ
- æ·»åŠ é€‚å½“çš„æµ‹è¯•
- æ›´æ–°æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

MIT License

---

*è¿™ä¸ªé¡¹ç›®æ­£åœ¨ç§¯æå¼€å‘ä¸­ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issueã€‚*
