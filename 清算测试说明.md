# 稳定币系统清算模块测试说明

## 概述

本文档详细说明如何使用稳定币系统的清算模块，包括系统部署、功能测试和清算流程。清算模块是稳定币系统的核心风险控制机制，用于处理高风险头寸的自动清算和拍卖。

## 系统架构

清算模块包含以下核心组件：

- **LiquidationManager**: 清算管理器，负责风险等级计算和清算触发
- **AuctionManager**: 拍卖管理器，负责被清算资产的拍卖流程
- **LinearDecrease**: 价格计算器，实现线性递减拍卖价格机制
- **CustodianFixed**: 托管合约，管理用户资产和净值计算

## 测试文件说明

### 1. deploy_full_system.js - 系统部署脚本

**功能**: 部署完整的稳定币系统，包括所有合约和权限配置

**使用方法**:
```bash
npx hardhat run scripts/auctions_test/deploy_full_system.js
```

**部署流程**:
1. 部署基础代币合约 (WLTC, StableToken, MultiLeverageToken)
2. 部署业务合约 (InterestManager, LTCPriceOracle)
3. 部署核心托管合约 (CustodianFixed)
4. 部署清算模块 (LinearDecrease, AuctionManager, LiquidationManager)
5. 配置合约参数和权限
6. 初始化系统
7. 保存部署信息到 JSON 文件

**重要参数**:
- 拍卖起始价格乘数: 1.0
- 拍卖重置时间: 2小时
- 调整阈值: 0.5 (净值低于50%时触发调整)
- 清算阈值: 0.3 (净值低于30%时触发清算)
- 惩罚金: 3%

### 2. basic_test.js - 基础功能测试

**功能**: 测试系统基础功能，包括铸币、净值计算和权限验证

**使用方法**:
```bash
npx hardhat run scripts/auctions_test/basic_test.js
```

**测试内容**:
- 合约连接和权限检查
- 用户铸币功能
- 净值计算验证
- 风险等级计算
- 系统统计信息

### 3. adjustment_test.js - 净值调整测试

**功能**: 测试净值调整功能，处理高风险头寸的自动调整

**使用方法**:
```bash
npx hardhat run scripts/auctions_test/adjustment_test.js
```

**测试场景**:
- 创建不同净值的代币
- 风险等级计算和更新
- 净值调整功能测试
- 边界条件验证
- 多用户并发测试

**净值调整流程**:
1. 当用户净值低于调整阈值(50%)时，系统允许用户进行净值调整
2. 用户可以选择调整一定比例的净值
3. 系统会创建新的代币并支付相应利息
4. 原代币余额减少，新代币余额增加

### 4. liquidation_test.js - 完整清算流程测试

**功能**: 测试完整的清算流程，从风险触发到拍卖完成

**使用方法**:
```bash
npx hardhat run scripts/auctions_test/liquidation_test.js
```

**清算流程**:
1. **准备阶段**: 分配资产、授权合约
2. **创建高风险头寸**: 设置高价格铸币，然后大幅降低价格
3. **触发清算条件**: 净值低于清算阈值(30%)
4. **发起清算**: Keeper调用bark函数启动拍卖
5. **拍卖流程**: 竞拍者参与拍卖购买底层资产
6. **完成清算**: 被清算用户提取稳定币

## 清算模块详细说明

### 风险等级系统

清算模块使用4级风险等级系统：

- **等级0**: 净值 > 调整阈值(50%) - 安全状态
- **等级1**: 净值在调整阈值附近 - 警告状态
- **等级2**: 净值低于调整阈值 - 可调整状态
- **等级3**: 净值接近清算阈值 - 高风险状态
- **等级4**: 净值低于清算阈值(30%) - 清算状态

### 核心函数说明

#### LiquidationManager 关键函数

1. **updateSingleTokensRiskLevel(user, tokenId)**
   - 更新单个代币的风险等级
   - 返回净值和新风险等级

2. **updateAllTokensRiskLevel(user)**
   - 更新用户所有代币的风险等级

3. **userLiquidationStatus(user, tokenId)**
   - 获取用户清算状态信息
   - 包括风险等级、冻结状态、拍卖ID等

4. **bark(user, tokenId, keeper)**
   - Keeper发起清算
   - 启动拍卖流程
   - 返回拍卖ID

5. **adjustNetValue(user, tokenId, percentage)**
   - 净值调整功能
   - 百分比范围: 1-100

6. **withdrawStable(user, tokenId)**
   - 被清算用户提取稳定币
   - 在拍卖完成后调用

#### AuctionManager 关键函数

1. **purchaseUnderlying(auctionId, maxPurchaseAmount, maxAcceptablePrice, receiver, callData)**
   - 竞拍者购买底层资产
   - 设置最大购买数量和最高可接受价格

2. **auctions(auctionId)**
   - 获取拍卖详细信息

3. **getAuctionStatus(auctionId)**
   - 获取拍卖状态和当前价格

## 测试账户角色

测试脚本使用以下角色账户：

- **部署者(Deployer)**: 系统部署和初始设置
- **被清算用户(LiquidatedUser)**: 持有高风险头寸的用户
- **Keeper**: 监控系统并触发清算的机器人
- **竞拍者(Bidder1, Bidder2)**: 参与拍卖购买资产的用户

## 测试场景示例

### 场景1: 正常铸币和净值计算
1. 设置预言机价格为 $100
2. 用户以 $80 价格铸币
3. 验证净值计算正确性

### 场景2: 净值调整
1. 创建低净值代币
2. 触发风险等级更新
3. 执行净值调整
4. 验证新代币创建和利息支付

### 场景3: 完整清算流程
1. 创建高风险头寸
2. 大幅降低价格触发清算
3. Keeper发起清算
4. 竞拍者参与拍卖
5. 被清算用户提取稳定币

## 运行测试的步骤

### 步骤1: 部署系统
```bash
npx hardhat run scripts/auctions_test/deploy_full_system.js
```

### 步骤2: 基础功能测试
```bash
npx hardhat run scripts/auctions_test/basic_test.js
```

### 步骤3: 净值调整测试
```bash
npx hardhat run scripts/auctions_test/adjustment_test.js
```

### 步骤4: 完整清算测试
```bash
npx hardhat run scripts/auctions_test/liquidation_test.js
```
